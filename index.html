
import React, { useState, useEffect, useRef } from 'react';
import useLocalStorage from './hooks/useLocalStorage';
import { Campaign } from './types';
import CampaignForm from './components/CampaignForm';
import Calendar from './components/Calendar';

const SunIcon: React.FC<{className?: string}> = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg>;
const MoonIcon: React.FC<{className?: string}> = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>;
const UploadIcon: React.FC<{className?: string}> = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>;
const DownloadIcon: React.FC<{className?: string}> = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>;
const EditIcon: React.FC<{className?: string}> = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>;

function App() {
  const [campaign, setCampaign] = useLocalStorage<Campaign | null>('prayerCampaign', null);
  const [theme, setTheme] = useLocalStorage<'light' | 'dark'>('theme', 'light');
  const [isEditing, setIsEditing] = useState(false);
  const [currentMonth, setCurrentMonth] = useState(new Date());
  const fileInputRef = useRef<HTMLInputElement>(null);

  useEffect(() => {
    if (theme === 'dark') {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  }, [theme]);
  
  useEffect(() => {
    if(campaign) {
      setCurrentMonth(new Date(campaign.startDate + 'T00:00:00'));
    }
  }, [campaign?.startDate]);

  const toggleTheme = () => {
    setTheme(prevTheme => (prevTheme === 'light' ? 'dark' : 'light'));
  };

  const handleStartCampaign = (data: Omit<Campaign, 'completedDays'>) => {
    setCampaign({ ...data, completedDays: [] });
  };
  
  const handleUpdateCampaign = (data: Omit<Campaign, 'completedDays'>) => {
    if(campaign) {
        // Keep completed days that are within the new date range
        const start = new Date(data.startDate + 'T00:00:00');
        const end = new Date(start);
        end.setDate(start.getDate() + data.duration - 1);

        const newCompletedDays = campaign.completedDays.filter(day => {
            const d = new Date(day + 'T00:00:00');
            return d >= start && d <= end;
        });
        
        setCampaign({ ...campaign, ...data, completedDays: newCompletedDays });
    }
    setIsEditing(false);
  }

  const handleToggleDay = (date: string) => {
    if (!campaign) return;
    const updatedCompletedDays = campaign.completedDays.includes(date)
      ? campaign.completedDays.filter(d => d !== date)
      : [...campaign.completedDays, date];
    setCampaign({ ...campaign, completedDays: updatedCompletedDays });
  };
  
  const handleEndCampaign = () => {
    if (window.confirm('Tem certeza que deseja encerrar a campanha atual?')) {
      setCampaign(null);
    }
  };

  const handleSaveToFile = () => {
    if (!campaign) return;
    const dataStr = JSON.stringify(campaign, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
    const exportFileDefaultName = 'campanha-oracao.json';
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
  };

  const handleLoadFileClick = () => {
    fileInputRef.current?.click();
  };

  const handleLoadFromFile = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const result = e.target?.result;
          if (typeof result === 'string') {
            const loadedCampaign: Campaign = JSON.parse(result);
            // Basic validation
            if (loadedCampaign.purpose && loadedCampaign.duration && loadedCampaign.startDate && Array.isArray(loadedCampaign.completedDays)) {
              setCampaign(loadedCampaign);
            } else {
              alert('Arquivo de campanha inválido.');
            }
          }
        } catch (error) {
          alert('Erro ao ler o arquivo.');
        }
      };
      reader.readAsText(file);
      // Reset file input value to allow loading the same file again
      event.target.value = '';
    }
  };


  const renderCampaign = () => {
    if (!campaign) return null;
    const progress = (campaign.completedDays.length / campaign.duration) * 100;

    if (isEditing) {
        return (
            <CampaignForm 
                onSubmit={handleUpdateCampaign}
                onCancel={() => setIsEditing(false)}
                initialData={campaign}
                submitButtonText="Salvar Alterações"
            />
        );
    }

    return (
      <div className="space-y-8">
        <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg w-full transition-colors duration-300">
          <div className="flex justify-between items-center mb-2">
            <h2 className="text-xl font-bold text-indigo-600 dark:text-indigo-400">Propósito:</h2>
            <button onClick={() => setIsEditing(true)} className="p-2 rounded-full text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 transition" aria-label="Editar campanha">
                <EditIcon className="h-5 w-5" />
            </button>
          </div>
          <p className="text-slate-700 dark:text-slate-300 whitespace-pre-wrap">{campaign.purpose}</p>
          
          <div className="mt-6">
            <div className="flex justify-between items-center mb-1">
              <span className="text-sm font-medium text-slate-700 dark:text-slate-300">Progresso</span>
              <span className="text-sm font-medium text-indigo-600 dark:text-indigo-400">{campaign.completedDays.length} / {campaign.duration} dias</span>
            </div>
            <div className="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5">
              <div className="bg-gradient-to-r from-green-400 to-blue-500 h-2.5 rounded-full transition-all duration-500" style={{ width: `${progress}%` }}></div>
            </div>
          </div>
        </div>

        <Calendar
          campaign={campaign}
          onToggleDay={handleToggleDay}
          currentMonth={currentMonth}
          setCurrentMonth={setCurrentMonth}
        />
        
        <div className="flex flex-col sm:flex-row items-center justify-center gap-4">
            <button onClick={handleSaveToFile} className="w-full sm:w-auto flex items-center justify-center bg-slate-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 dark:focus:ring-offset-slate-900 transition-transform transform hover:scale-105">
                <DownloadIcon className="h-5 w-5 mr-2" /> Salvar Dados
            </button>
            <button onClick={handleEndCampaign} className="w-full sm:w-auto bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 dark:focus:ring-offset-slate-900 transition-transform transform hover:scale-105">
                Encerrar Campanha
            </button>
        </div>
      </div>
    );
  };
  
  const renderWelcome = () => {
    return (
        <div className="text-center">
            <div className="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg w-full max-w-lg mx-auto mb-8 transition-colors duration-300">
                <h2 className="text-2xl font-bold mb-6 text-indigo-600 dark:text-indigo-400">Comece sua jornada de oração</h2>
                <CampaignForm onSubmit={handleStartCampaign} submitButtonText="Iniciar Campanha" />
            </div>
             <div className="flex items-center justify-center text-slate-500 dark:text-slate-400">
                <span className="flex-grow bg-slate-300 dark:bg-slate-700 h-px"></span>
                <span className="px-4 text-sm">Ou</span>
                <span className="flex-grow bg-slate-300 dark:bg-slate-700 h-px"></span>
            </div>
            <div className="mt-8">
                <button onClick={handleLoadFileClick} className="inline-flex items-center text-indigo-600 dark:text-indigo-400 font-semibold hover:underline">
                    <UploadIcon className="h-5 w-5 mr-2" />
                    Carregar campanha de um arquivo
                </button>
                <input type="file" ref={fileInputRef} onChange={handleLoadFromFile} className="hidden" accept=".json"/>
            </div>
        </div>
    );
  };

  return (
    <div className="min-h-screen bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 p-4 sm:p-6 lg:p-8 flex flex-col items-center">
        <header className="w-full max-w-4xl flex justify-between items-center mb-8">
            <div className="text-left">
                <h1 className="text-4xl sm:text-5xl font-extrabold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-indigo-500 to-purple-500">
                    Campanha de Oração
                </h1>
                <p className="mt-1 text-base text-slate-600 dark:text-slate-400">
                    Seu diário de fé e perseverança.
                </p>
            </div>
            <button onClick={toggleTheme} className="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition" aria-label="Toggle theme">
                {theme === 'light' ? <MoonIcon className="h-6 w-6 text-slate-600"/> : <SunIcon className="h-6 w-6 text-yellow-400"/>}
            </button>
        </header>
        <main className="w-full max-w-4xl">
            {campaign ? renderCampaign() : renderWelcome()}
        </main>
        <footer className="text-center mt-12 text-slate-500 dark:text-slate-500 text-sm">
            <p>Desenvolvido com fé e tecnologia.</p>
        </footer>
    </div>
  );
}

export default App;
